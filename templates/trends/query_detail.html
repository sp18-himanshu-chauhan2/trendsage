{% extends "base.html" %}
{% load humanize %}

{% block content %}
<h2>Query Results</h2>

<p><strong>Industry:</strong> {{ query.industry }}</p>
<p><strong>Region:</strong> {{ query.region }}</p>
<p><strong>Persona:</strong> {{ query.persona }}</p>
<p><strong>Date Range:</strong> {{ query.date_range }}</p>
<p><strong>Status:</strong> {{ query.status }}</p>
<p><strong>Last Updated:</strong> {{ query.updated_at|naturaltime }}</p>

{% if subscription and not subscription.is_active %}
    <div class="alert alert-warning text-center my-5">
        <h5>üîí Query Deactivated</h5>
        <p>You have deactivated this query. Reactivate it anytime to see the latest results.</p>
    </div>
{% elif results.exists %}
    {% if versions %}
        <p>
            <strong>Viewing Version:</strong> {{ version }}
            <br>
            <strong>Other Versions:</strong>
            {% for v in versions %}
                {% if v == version %}
                    <span class="badge bg-primary">{{ v }}</span>
                {% else %}
                    <a href="?version={{ v }}" class="badge bg-secondary">{{ v }}</a>
                {% endif %}
            {% endfor %}
        </p>
    {% endif %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Topic</th>
                <th>Summary</th>
                <th>Final Score</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for trend in results %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ trend.topic }}</td>
                <td>{{ trend.summary|truncatechars:100 }}</td>
                <td>{{ trend.final_score }}</td>
                <td>
                    <a href="{% url 'trend-result-detail-frontend' query.id trend.id %}" class="btn btn-sm btn-info">
                        View
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% elif query.status == "pending" or query.status == "running" %}
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Processing‚Ä¶ please wait ‚è≥</p>
        <p>The page will refresh automatically when results are ready.</p>
    </div>

    <script>
        // Auto-refresh after 5 seconds if results are empty
        setTimeout(function() {
            window.location.reload();
        }, 5000);
    </script>
{% else %}
    <div class="alert alert-info text-center my-5">
        <p>Unable to load results. Please check your internet connection or try again.</p>
        {% csrf_token %}
        {% if query.status == "failed" %}
            <input type="hidden" name="" value="" />
            <button class="btn btn-sm btn-primary mb-3">Refresh</button>
        {% endif %}
    </div>
{% endif %}

{% if query.status != "failed" %}
    <form method="post" action="{% url 'toggle-subscription' query.id %}">
        {% csrf_token %}
        {% if subscription and subscription.wants_emails %}
            <input type="hidden" name="action" value="unsubscribe" />
            <button class="btn btn-sm btn-danger mb-3">Disable Notifications</button>
        {% else %}
            <input type="hidden" name="action" value="subscribe" />
            <button class="btn btn-sm btn-primary mb-3">Enable Notifications</button>
        {% endif %}
    </form>

    <form method="post" action="{% url 'toggle-subscription' query.id %}">
        {% csrf_token %}
        {% if subscription and subscription.is_active %}
            <input type="hidden" name="action" value="deactivate" />
            <button class="btn btn-sm btn-warning">Deactivate</button>
        {% else %}
            <input type="hidden" name="action" value="activate" />
            <button class="btn btn-sm btn-success">Activate</button>
        {% endif %}
    </form>
{% endif %}

<a href="{% url 'dashboard' %}" class="btn btn-secondary mt-3">‚Üê Back to Dashboard</a>
{% endblock %}

{% extends "base.html" %}
{% load humanize %}

{% block content %}
<h2>Query Results</h2>

<p><strong>Industry:</strong> {{ query.industry }}</p>
<p><strong>Region:</strong> {{ query.region }}</p>
<p><strong>Persona:</strong> {{ query.persona }}</p>
<p><strong>Date Range:</strong> {{ query.date_range }}</p>
<p><strong>Status:</strong> {{ query.status }}</p>
<p><strong>Last Updated:</strong> 
    <span class="last-updated" data-time="{{ query.updated_at|date:'c' }}"></span>
</p>

{% if subscription and not subscription.is_active %}
    <div class="alert alert-warning text-center my-5">
        <h5>üîí Query Deactivated</h5>
        <p>You have deactivated this query. Reactivate it anytime to see the latest results.</p>
    </div>
{% elif results.exists %}
    {% if versions %}
        <p>
            <strong>Viewing Version:</strong> {{ version }}
            <br>
            <strong>Other Versions:</strong>
            {% for v in versions %}
                {% if v == version %}
                    <span class="badge bg-primary">{{ v }}</span>
                {% else %}
                    <a href="?version={{ v }}" class="badge bg-secondary">{{ v }}</a>
                {% endif %}
            {% endfor %}
        </p>
    {% endif %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Topic</th>
                <th>Summary</th>
                <th>Final Score</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for trend in results %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ trend.topic }}</td>
                <td>{{ trend.summary|truncatechars:100 }}</td>
                <td>{{ trend.final_score }}</td>
                <td>
                    <a href="{% url 'trend-result-detail-frontend' query.id trend.id %}" class="btn btn-sm btn-info">
                        View
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% elif query.status == "pending" or query.status == "running" %}
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Processing‚Ä¶ please wait ‚è≥</p>
        <p>The page will refresh automatically when results are ready.</p>
    </div>

    <script>
        // Auto-refresh after 5 seconds if results are empty
        setTimeout(function() {
            window.location.reload();
        }, 5000);
    </script>
{% else %}
    <div class="alert alert-info text-center my-5">
        <p>No results available for this query yet.</p>
    </div>
{% endif %}

{% if query.status == "failed" %}
    <div id="refresh-area" class="text-center my-4">
        <form id="refresh-form" method="post" action="{% url 'query-retry-frontend' query.id %}">
            {% csrf_token %}
            <button id="refresh-btn" type="button" class="btn btn-primary">
                Retry Fetching Results
            </button>
            <span id="refresh-msg" class="ms-2"></span>
        </form>
    </div>
{% endif %}

{% if query.status != "failed" %}
    <form method="post" action="{% url 'toggle-subscription' query.id %}">
        {% csrf_token %}
        {% if subscription and subscription.wants_emails %}
            <input type="hidden" name="action" value="unsubscribe" />
            <button class="btn btn-sm btn-danger mb-3">Disable Notifications</button>
        {% else %}
            <input type="hidden" name="action" value="subscribe" />
            <button class="btn btn-sm btn-primary mb-3">Enable Notifications</button>
        {% endif %}
    </form>

    <form method="post" action="{% url 'toggle-subscription' query.id %}">
        {% csrf_token %}
        {% if subscription and subscription.is_active %}
            <input type="hidden" name="action" value="deactivate" />
            <button class="btn btn-sm btn-warning">Deactivate</button>
        {% else %}
            <input type="hidden" name="action" value="activate" />
            <button class="btn btn-sm btn-success">Activate</button>
        {% endif %}
    </form>
{% endif %}

<a href="{% url 'dashboard' %}" class="btn btn-secondary mt-3">‚Üê Back to Dashboard</a>

<script>
    (function()
    {
        const btn = document.getElementById('refresh-btn');
        if (!btn) return; // only exists if query.status == "failed"

        function getCookie(name) 
        {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') 
            {
            const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) 
                {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) 
                    {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        const msg = document.getElementById('refresh-msg');

        btn.addEventListener('click', async function (e) 
        {
            e.preventDefault();
            btn.disabled = true;
            const orig = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Refreshing...';
            msg.textContent = '';

            try 
            {
                const resp = await fetch("{% url 'query-retry-frontend' query.id %}",
                {
                    method: "POST",
                    headers: 
                    {
                        "X-CSRFToken": csrftoken,
                        "Accept": "application/json"
                    },
                    body: ""
                });

                const data = await resp.json().catch(() => ({}));
                if (resp.status === 202) 
                {
                    msg.innerHTML = '<span class="text-success">Refresh started ‚Äî results will update shortly.</span>';
                    btn.innerHTML = 'Refresh started';
                    setTimeout(() => window.location.reload(), 3000);
                } 
                else 
                {
                    msg.innerHTML = '<span class="text-danger">' + (data.error || "Failed to start refresh") + '</span>';
                    btn.disabled = false;
                    btn.innerHTML = orig;
                }
            } 
            catch (err) 
            {
                msg.innerHTML = '<span class="text-danger">Network error ‚Äî try again.</span>';
                btn.disabled = false;
                btn.innerHTML = orig;
            }
        });
    })();

    document.querySelectorAll('.last-updated').forEach(function(el) 
    {
        const utcTime = el.getAttribute('data-time'); // ISO 8601 datetime
        if (!utcTime) return;

        const updatedDate = new Date(utcTime);
        const now = new Date();
        const diffMs = now - updatedDate; // difference in milliseconds
        const oneDayMs = 24 * 60 * 60 * 1000;

        if (diffMs < oneDayMs) 
        {
            // Less than 1 day ago ‚Üí show relative time
            const seconds = Math.floor(diffMs / 1000);
            let relative = "";
            if (seconds < 60) relative = "just now";
            else if (seconds < 3600) relative = Math.floor(seconds/60) + " minutes ago";
            else relative = Math.floor(seconds/3600) + " hours ago";
            el.textContent = relative;
        } 
        else 
        {
            // More than 1 day ‚Üí show absolute local time
            const options = { 
                year: 'numeric', month: 'short', day: 'numeric',
                hour: 'numeric', minute: 'numeric',
                hour12: true
            };
            el.textContent = updatedDate.toLocaleString(undefined, options);
        }
    });
</script>
{% endblock %}
